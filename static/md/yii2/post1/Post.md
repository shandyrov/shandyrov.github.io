# Yii TDD BDD с Codeception

По мере того, как внедряемое нами программное обеспечение начинает расти, мы понимаем, насколько важно проводить непрерывное тестирование. Например, когда мы пишем класс на PHP, мы тестируем его с помощью операторов «echo», «die» или «print» для проверки реализации. Если это полноценное веб-приложение, мы проверяем его функциональность, вводя тестовые данные в формы и проверяем, как оно работает.

Этот процесс тестирования можно автоматизировать, поэтому каждый раз, когда нам нужно что-то проверить, мы просто вызываем код тестирования, и он выполняет свою работу вместо проверки вручную.

Разработка на основе тестов (TDD) и Разработка на основе поведения (BDD) - это методы реализации программного обеспечения путем описания поведения части кода или всей функции в виде набора сценариев или тестов перед написанием фактического кода.

Используя TDD/BDD, мы выполняем следующие шаги при разработке функционала:

-   Создайте новый тест, описывающий реализуемую функцию.
-   Запустите новый тест и убедитесь, что он не прошел. Он должен провалиться, поскольку еще не доделан.
-   Напишите простой код, чтобы новый тест прошел успешно.
-   Запустите все тесты и убедитесь, что все они прошли.
-   Улучшите код и убедитесь, что тесты все еще в порядке.

Повторите шаги еще раз для другого функционала или доработки. Если существующие функции меняются, необходимо изменить и тесты.

## Когда уместно писать тестовые примеры?

-   Проект уже большой и сложный.
-   Требования к проекту начинают усложняться.
-   Проект рассчитан на долгую перспективу.
-   Цена провала слишком высока.

## TDD vs BDD

-   TDD хорошо подходит для юнит-тестирования, т.е. для проверки работы отдельных модулей самих по себе. BDD — для интеграционного (т.е. для проверки, как отдельные модули работают друг с другом) и для проверки всей системы целиком.
-   TDD: тесты сразу реализуются в коде, для BDD чаще всего описываются шаги на языке, понятном всем, а не только разработчикам.
-   TDD: юнит-тесты пишут сами разработчики. BDD требует объедения усилий разных членов команды. Обычно тест-кейсы (шаги) описываются ручным тестировщиком или аналитиком и воплощаются в код тестировщиком-автоматизатором. В нашей команде мы (фронтенедеры) описываем шаги вместе с тестировщиками, а код тестов пишет фронтенд-команда.
-   TDD проверяет работу функций, BDD — пользовательские сценарии.

## Давайте настроим среду

Выполните следующие команды, чтобы установить codeception с помощью composer.

```bash
$ composer require “codeception/codeception:*”
$ alias cept=”./vendor/bin/codecept”
```

Можете проверить, запустив cept --version

### Давайте посмотрим, как писать приемочные, функциональные и модульные тесты с использованием Codeception в структуре Yii.

Создание первого примера приемочного теста:

Давайте проверим, что наш сайт открывает главную страницу и страницу «О нас», и они возвращают правильный код ответа «200» и содержат ожидаемые ключевые слова. Цель приемочных тестов - проверить, что доступно человеку, далекому от программирования: просмотр содержимого страницы, попытка авторизации и т. д.

Откройте файл tests/accept/SmokeTestCept.php и добавьте следующие строки. (Мы можем сгенерировать SmokeTestCept, запустив cept g:cest acceptance SmokeTestCept)

```bash
$I = new AcceptanceTester($scenario);
$I->wantTo('Убедимся, что MainPage и About работают');
$I->amOnPage('/');
$I->seeResponseCodeIs(\Codeception\Util\HttpCode::OK);
$I->see('Home'); // фраза с главной страницы
$I->amOnPage('/about');
$I->seeResponseCodeIs(\Codeception\Util\HttpCode::OK);
$I->see('About'); // фраза со страницы о нас
```

Добавьте URL сайта в конфигурацию по адресу tests/accept.yml

```yml
modules:
    enabled:
        - WebDriver:
              url: http://127.0.0.1:8080/
              browser: firefox
        - Yii2:
              part: [orm, fixtures] # позволяют использовать методы AR
              cleanup: false # не оборачивать тест в транзакцию
              entryScript: index-test.php
```

**cept build** - необходимо запустить это после внесения изменений в файлы конфигурации  
**cept** run accept - для запуска приемочных тестов

Вы должны получить сообщение: OK (1 test, 4 assertion)

Используя этот метод, мы можем тестировать формы, Ajax, REST API, JavaScript и многое другое.

## Создание первого функционального тестового примера:

Функциональные тесты похожи на приемочные, но мы не запускаем на веб-сервере, вместо этого мы запускаем на эмуляторе. Поэтому мы не видим, как он перемещается по веб-страницам, как при приемочном тестировании.

Файл конфигурации функционального теста находится в файле tests/function.suite.yml.
Нам нужно включить модуль Yii2 для функциональных тестов.

```php
modules:
    enabled:
        - Yii2:
            configFile: 'config/test.php'
```

Нужно предоставить другую базу данных для тестирования

```php
// config/test.php
<?php
// config/test.php
$config = yii\helpers\ArrayHelper::merge(
 require(__DIR__ . ‘/main.php’),
 require(__DIR__ . ‘/main-local.php’),
 [
 ‘id’ => ‘app-tests’,
 ‘components’ => [
 ‘db’ => [
 ‘dsn’ => ‘mysql:host=localhost;dbname=yii_app_test’,
 ]
 ]
 ]
);
return $config;
```

Для создания функционального тестового примера мы можем запустить:

```
cept g: cest function myFirstFunctionalCept
```

```php
$I = new FunctionalTester($scenario);
$I->wantTo('Убедимся, что MainPage и About работают');
$I->amOnPage('/');
$I->seeResponseCodeIs(\Codeception\Util\HttpCode::OK);
$I->see('Home'); // Фраза с главной страницы
$I->amOnPage('/about');
$I->seeResponseCodeIs(\Codeception\Util\HttpCode::OK);
$I->see('About'); // Фраза со страницы О нас
```

**cept run function** - для запуска функциональных тестов.
Вы должны получить сообщение: **OK (1 test, 4 assertion)**

## Создание первого Unit тест кейса:

Модульные тесты находятся в каталоге tests/unit и должны содержать все виды модульного и интеграционного тестирования. Нам также необходимо включить модуль Yii2 для модульных тестов.

Конфигурация находится по адресу tests/unit.suite.yml

```php
modules:
    enabled:
      - Yii2:
            part: [orm, email]
```

Он имеет части orm и email, чтобы исключить методы, необходимые только для функционального тестирования.

Чтобы сгенерировать модульный тестовый пример, мы можем запустить **g: cest unit UserTest**
Типичный модульный тест может выглядеть так:

```php
<?php
class UserTest extends \Codeception\Test\Unit
{
    public function testValidation()
    {
        $user = new User();
        $user->setName(null);
        $this->assertFalse($user->validate(['username']));
        $user->setName('hello');
        $this->assertFalse($user->validate(['username']));
        $user->setName('world');
        $this->assertTrue($user->validate(['username']));
    }
}
```

**cept run unit** - для запуска модульных тестов
Мы должны увидеть сообщение: OK (1 test, 3 assertions)

Есть много утверждений, которые вы можете использовать внутри тестов. Наиболее распространены:

```php
$this->assertEquals()
$this->assertContains()
$this->assertFalse()
$this->assertTrue()
$this->assertNull()
$this->assertEmpty()
```

## Вывод

Чем больше вы используете TDD, тем проще становится TDD.
Сначала вам будет нелегко прывыкнуть, но применение TDD в вашем проекте сделает вас лучшим разработчиком и облегчит вашу жизнь.
Цель TDD - не писать много сложного кода, а писать код, с которым легко работать и поддерживать.
